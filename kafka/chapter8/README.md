# 八、可靠性探究

Kafka采用多副本机制，来实现水平扩展、提供容灾能力、提升可用性和可靠性等

- 多副本之间如何进行数据同步？
- 多副本数据一致性如何解决？
- 如何确保kafka的可靠性？
- Kafka可靠性与可用性之间的关系是什么？

## 8.1 副本剖析

Kafka通过增加副本数量提升数据容灾能力，通过多副本机制实现故障自动转移。

相关概念：
- 副本是相对于分区而言的
- 一个分区包含一个或多个副本，其中一个为leader副本，其余为follower副本，各个副本位于不同的broker节点中，只有leader副本对外提供服务，follower副本只负责数据同步
- 分区中所有的副本统称为AR，而ISR指与leader副本保持同步状态的副本集合
- LEO标识每个分区中最后一条消息的下一个位置，分区的每个副本都有自己的LEO，ISR中最小的LEO即为HW，俗称高水位，消费者只能拉取到HW之前的消息

生产者发出一条消息，首先被写入分区的leader副本，只有ISR集合中的所有follower副本都同步了这条消息之后，才会更新分区的HW，进而消费者才可以消费到这个消息

### 8.1.1 失效副本

在ISR集合之外，处于同步失效或功能失效的副本称为失效副本，同步失效的分区称为同步失效分区，即 under-replicated 分区

可通过 kafka-topic.sh 脚本的 under-replicated-partitions 参数来显示主题中包含失效副本的分区

从0.9版本开始，通过唯一的 broker端参数 replica.lag.time.max.ms 来抉择，当ISR集合中的一个follower副本滞后leader副本的时间超过此参数指定的值则判定为同步失败，默认为10000

### 8.1.2 ISR的伸缩

有两个和ISR相关的定时任务：
- isr-expiration 周期性的检测每个分区是否需要缩减其ISR集合
- isr-change-propagation 周期性的检测 ISR集合变更记录

### 8.1.3 LEO 和 HW

1. 生产者客户端发送消息至leader副本中
2. 消息被追加到leader副本的本地日志，并更新日志的偏移量
3. follow副本向leader副本请求同步数据
4. leader副本读取本地日志，并更新对应拉取的follow副本的信息
5. leader副本所在的服务器将拉取结果返回给follower副本
6. follower副本收到leader副本返回的拉取结果，将消息追加到本地日志中，并更新日志的偏移量信息

### 8.1.4 Leader Epoch的介入

通过 leader epoch 防止副本数据丢失

### 8.1.5 为什么不支持读写分离

主写从读的2个缺点：
- 数据一致性问题
- 延时问题

Kafka支持主写主读的优点：
- 简化代码实现逻辑
- 负载粒度细化均摊
- 无延时影响
- 不会出现数据不一致的情况

## 8.2 日志同步机制

ISR集合

## 8.3 可靠性分析

- 副本数的设置，一般为3，可靠性要求更高的场景，设置为5或者更多
- acks参数的设置以及部分参数的设置





