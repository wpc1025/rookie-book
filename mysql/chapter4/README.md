
## 锁

> [详解 MySql InnoDB 中的三种行锁（记录锁、间隙锁与临键锁）](https://juejin.im/post/5b8577c26fb9a01a143fe04e)
    

1. 共享锁

    **共享锁（`Shared Locks`）**又称为读锁，是指多个事务对同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。

2. 排他锁

    **排他锁（`Exclusive Locks`）**又称为写锁，指一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，获得排他锁的事务可以对数据就行读取和修改。
    
    eg:
    - `InnoDB`引擎默认的修改数据语句，`update`、`delete`、`insert`都会自动给涉及到数据加上排他锁；`select`语句默认不会加任何锁类型。
    - 可以通过`for update`语句加上排他锁，通过`lock in share mode`语句加共享锁

3. 意向共享锁

    意向共享锁（`intention shared lock`）事务有意向对表中的某些行加共享锁
    
4. 意向排他锁

    意向排他锁（`intention exclusive lock`）事务有意向对表中的某些行加排他锁
    
    eg:
    - 意向锁存在的意义：当为一张表加上排他锁时，我们首先判断这张表没有其他排他锁，其次判断这张表的所有行没有持有排他锁。当我们有了意向锁之后，就不必检查表中各行是否存在排他锁，提高了效率。
    - 意向锁属于表锁，由数据引擎自己维护，用户无法手动操作意向锁；在为数据行加共享/排他锁之前，`InnoDB`会先获取该数据行所在数据表对应的意向锁。
    - 意向锁不会与行级的共享/排他锁互斥，只会和表级的共享锁、排他锁发生冲突。
    
    | | IS | IX | S |  X |
    |:--- | :--- | :--- | :--- | :---|
    | IS | 兼容 | 兼容 | 兼容 | 冲突 |
    | IX | 兼容 | 兼容 | 冲突 | 冲突 |
    | S | 兼容 | 冲突 | 兼容 | 冲突 |
    | X | 冲突 | 冲突 | 冲突 | 冲突 |

5. 记录锁

    记录锁（`Record Locks`）为某行记录加锁
    
    ```sql
    # id 列为主键或唯一索引列
    select * from table where id = 1 for update;
    ```
    
    eg:
    - 语句必须为精准匹配（=），不能为`<`、`>`、`like`等，否则会退化为`临键锁`
    - `id`列必须为`唯一索引列`或`主键列`，否则上述语句的锁会变成`临键锁`
    
6. 间隙锁

    间隙锁（`Gap Locks`），基于`非唯一索引`，锁定一段范围内的索引记录。
    
    ```sql
    select * from table where id between 1 and 10 for update;
    ```
    
    eg:
    - 所有在（1，10）区间内的记录行都会被锁住
    - `间隙锁`基于`临键锁`实现
    
7. 临键锁

    临键锁（`Next-Key Locks`），可以理解为一种特殊的间隙锁
    
    eg：
    - 临键锁只与非唯一索引有关，在唯一索引上不存在临键锁
    - 当某个事务持有该数据行的临键锁时，会锁住一段左开右闭区间的数据
    - `InnoDB`中的行锁的实现依赖于`索引`，一旦某个加锁操作没有使用索引，那么该锁就会退化为`表锁`
    
[详解 MySql InnoDB 中的三种行锁（记录锁、间隙锁与临键锁）](https://juejin.im/post/5b8577c26fb9a01a143fe04e)
    


