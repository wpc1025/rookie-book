# 数据安全和性能保障

## 1. 持久化选项

两种不同的持久化方法来将数据存储到硬盘里面：
- 快照：将存在于某一时刻的所有数据都写入硬盘里面
- 只追加文件（append-only file，AOF）：会在执行写命令时，将被执行的写命令复制到硬盘里面

### 1.1.1 快照持久化

快照被写入dbfilename选项指定的文件里面，并存储在dir选项指定的路径上面。如果在新的快照文件创建完毕之前，Redis、系统或者硬件这三者之中的任意一个崩溃了，那么Redis将丢失最近一次创建快照之后写入的所有数据。

创建快照的办法有以下几种：
- 客户端通过向Redis发送`BGSAVE`命令来创建一个快照。对于支持BGSAVE命令的平台来说，Redis会调用fork来创建一个子进程，然后子进程负责将快照写入磁盘，而父进程则继续处理命令请求。
- 客户端通过向Redis发送`SAVE`命令来创建一个快照，接到SAVE命令的Redis服务器在快照创建完毕之前将不再响应任何其他命令。
- 如果用户设置了save配置选项，比如 `save 60 10000`，那么从Redis最近一次创建快照之后开始算起，当“60秒之内有10000次写入”这个条件被满足时，Redis就会自动触发BGSAVE命令。
- 当Redis通过`SHUTDOWN`命令接收到关闭服务器的请求时，或者接收到标准TERM信号时，会执行一个SAVE命令，阻塞所有客户端，不再执行客户端发送的任何命令，并在SAVE命令执行完毕之后关闭服务器。
- 当一个Redis服务器连接另一个Redis服务器，并向对方发送SYNC命令来开始一次复制操作的时候，如果主服务器目前没有在执行BGSAVE操作，或者主服务器并非刚刚执行完BGSAVE操作，那么主服务器就会执行BGSAVE命令。

### 1.1.2 AOF持久化

AOF持久化会将被执行的写命令写到AOF文件的末尾，以此来记录数据发生的变化。

AOF持久化可以通过`appendonly yes`配置选项来打开。

appendfsync选项及同步频率

| 选项 | 同步频率 |
| :--- | :--- |
| always | 每个Redis写命令都要同步写入硬盘。这样做会严重降低Redis的速度 |
| everysec | 每秒执行一次同步，显式的将多个写命令同步到硬盘 |
| no | 让操作系统来决定应该何时进行同步 |

AOF文件体积不断增大问题如何解决？
- 用户可以向Redis发送`BGREWRITEAOF`命令，这个命令会移除AOF文件中的冗余命令来重写AOF文件，使AOF文件的体积变的尽可能的小。`BGRERITEAOF`命令可能会导致性能问题和内存占用问题，且在进行AOF重写并删除旧AOF文件的时候，删除一个体积达到数十GB大的旧AOF文件可能会导致操作系统挂起数秒。
- 通过`auto-aof-rewrite-percentage`和`auto-aof-rewrite-min-size`选项来自动执行`BGREWRITEAOF`。如 `auto-aof-rewrite-percentage 100` 和 `auto-aof-rewrite-min-size 64mb`，当AOF文件体积比上一次重写之后的体积大了至少一倍的时候，Redis将执行BGREWRITEAOF命令。

## 1.2 复制

复制可以让其他服务器拥有一个不断的更新的数据副本，从而使得拥有数据副本的服务器可以用于处理客户端发送的读请求。

### 1.2.1 对Redis的复制相关特性进行配置

注意事项：
- 从服务器连接主服务器时，主服务器会执行`BGSAVE`操作，为了正确的使用复制特性，用户需要保证主服务器正确的设置了`dir`选项和`dbfilename`选项，且这两个选项所指示的路径和文件对于Redis进程都是可写的。
- 从服务器必须的选项是 `slaveof`，通过配置文件、命令都可以执行`slaveof host port`

### 1.2.2 Redis复制的启动过程

从服务器连接主服务器时的步骤

| 步骤 | 主服务器操作 | 从服务器操作|
| :--- | :--- | :---|
| 1 | 等待命令进入 | 连接（或重连接）主服务器，发送SYNC命令 |
| 2 | 开始执行`BGSAVE`，并使用缓冲区记录`BGSAVE`之后执行的所有写命令 | 根据配置选项来决定是继续使用现有的数据（如果有的话）来处理客户端的命令请求，还是向客户端返回错误 | 
| 3 | `BGSAVE`执行完毕，向从服务器发送快照文件，并在发送期间继续使用缓冲区记录被执行的写命令 | 丢弃所有旧数据（如果有的话），开始载入主服务器发来的快照文件 |
| 4 | 快照文件发送完毕，开始向从服务器发送储存在缓冲区中的写命令 | 完成对快照文件的解释操作，像往常一样开始接受命令请求 | 
| 5 | 缓冲区存储的写命令发送完毕，从现在开始每执行一个写命令，就向从服务器发送相同的写命令 | 执行主服务器发来的所有存储在缓冲区里的写命令，并从现在开始，接收并执行主服务器传来的每个写命令 |

当一个主服务器连接一个已有的主服务器时，有时可以重用已有的快照文件。

### 1.2.3 主从链

### 1.2.4 检验硬盘写入

## 1.3 处理系统故障

### 1.3.1 验证快照文件和AOF文件

- `redis-check-aof`

    `redis-check-aof [--fix] <file.aof>` 对AOF进行修复，程序会删除第一个出错命令以及该出错命令之后的所有命令
    
- `redis-check-dump`
    
暂时没有办法修复快照文件。

### 1.3.2 更换故障主服务器

## 1.4 Redis事务





